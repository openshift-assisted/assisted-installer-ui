name: Push to master or feature branches

on:
  push:
    branches:
      - master
      - features/*
      - bugs/*

jobs:
  push-to-quay-io:
    if: ${{ github.repository == 'openshift-assisted/assisted-ui-lib' }}
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max-old-space-size=8192
      GH_REPO_OWNER: openshift-assisted
      QUAY_IO_REGISTRY_OWNER: edge-infrastructure
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup NodeJS
        uses: actions/setup-node@v3
        with:
          node-version: ${{ vars.NODEJS_VERSION }}
          cache: yarn

      - name: Define additional environment variables
        uses: actions/github-script@v6
        with:
          script: |
            const normalized_branch_name = "${{ github.ref_name }}".replaceAll('/','_').toLowerCase();
            core.exportVariable('AIUI_APP_VERSION', normalized_branch_name);
            const short_sha = `${"${{ github.sha }}".slice(0,8)}`;
            core.exportVariable('AIUI_APP_GIT_SHA', short_sha);
            const ui_lib_package_version = `0.0.0+sha.${short_sha}`;
            core.exportVariable('UI_LIB_PACKAGE_VERSION', ui_lib_package_version);

      - name: Change the package version in assisted-ui-lib to ${{ env.UI_LIB_PACKAGE_VERSION }}
        run: node scripts/package-edit-version.js ./package.json "$UI_LIB_PACKAGE_VERSION"

      - name: Install dependencies
        run: yarn install --immutable

      - name: Get container image tags
        # Appends the 'latest' tag only if the commit was pushed to 'master'
        id: get-tags
        uses: actions/github-script@v6
        with:
          script: |
            const tags = ['${{ env.AIUI_APP_GIT_SHA }}', '${{ env.AIUI_APP_VERSION }}'];
            if ('${{ github.ref_name }}' === 'master')
              core.setOutput('tags', tags.concat('latest', 'latest-${{ github.sha }}').join(' '));
            else
              core.setOutput('tags', tags.join(' '));

      - name: Build the assisted-ui image
        id: build-image
        uses: redhat-actions/buildah-build@v2
        with:
          image: assisted-installer-ui
          tags: ${{ steps.get-tags.outputs.tags }}
          build-args: |
            AIUI_APP_GIT_SHA=${{ env.AIUI_APP_GIT_SHA }}
            AIUI_APP_VERSION=${{ env.AIUI_APP_VERSION }}
          containerfiles: ./assisted-ui/hacks/custom.Dockerfile
          context: ./apps/assisted-ui

      - name: Push the assisted-ui image to Quay.io
        uses: redhat-actions/push-to-registry@v2.7
        with:
          image: ${{ steps.build-image.outputs.image }}
          tags: ${{ steps.build-image.outputs.tags }}
          registry: quay.io/${{ env.QUAY_IO_REGISTRY_OWNER }}
          username: ${{ secrets.QUAYIO_EDGE_INFRA_USERNAME }}
          password: ${{ secrets.QUAYIO_EDGE_INFRA_PASSWORD }}
