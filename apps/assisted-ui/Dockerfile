FROM registry.access.redhat.com/ubi8/nodejs-16 as builder

ENV CI='true'

ARG REACT_APP_CLUSTER_PERMISSIONS
ENV REACT_APP_CLUSTER_PERMISSIONS=$REACT_APP_CLUSTER_PERMISSIONS
ARG VITE_APP_API_ROOT
ENV VITE_APP_API_ROOT=$VITE_APP_API_ROOT
ARG VITE_APP_IMAGE_REPO
ENV VITE_APP_IMAGE_REPO=$VITE_APP_IMAGE_REPO
ARG VITE_APP_GIT_SHA
ENV VITE_APP_GIT_SHA=$VITE_APP_GIT_SHA
ARG VITE_APP_VERSION
ENV VITE_APP_VERSION=$VITE_APP_VERSION

COPY --chown=1001:0 / $HOME/repo

WORKDIR $HOME/repo
RUN npm install --global yarn && \
    yarn install &&  \
    yarn run build:apps/assisted-ui &&  \
    cp -r apps/assisted-ui/{build,deploy} $HOME

FROM registry.access.redhat.com/ubi8/nginx-120 as app

ARG REACT_APP_CLUSTER_PERMISSIONS
ENV REACT_APP_CLUSTER_PERMISSIONS=$REACT_APP_CLUSTER_PERMISSIONS
ARG VITE_APP_API_ROOT
ENV VITE_APP_API_ROOT=$VITE_APP_API_ROOT
ARG VITE_APP_IMAGE_REPO
ENV VITE_APP_IMAGE_REPO=$VITE_APP_IMAGE_REPO
ARG VITE_APP_GIT_SHA
ENV VITE_APP_GIT_SHA=$VITE_APP_GIT_SHA
ARG VITE_APP_VERSION
ENV VITE_APP_VERSION=$VITE_APP_VERSION

COPY --from=builder /opt/app-root/src/build/ "${NGINX_APP_ROOT}/src/"
COPY --from=builder /opt/app-root/src/deploy/ /deploy/

CMD [ "/deploy/start.sh" ]
