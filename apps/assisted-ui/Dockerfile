FROM registry.access.redhat.com/ubi8/nodejs-16 as builder

ENV CI='true'

ARG AIUI_APP_CLUSTER_PERMISSIONS
ENV AIUI_APP_CLUSTER_PERMISSIONS=$AIUI_APP_CLUSTER_PERMISSIONS
ARG AIUI_APP_API_ROOT
ENV AIUI_APP_API_ROOT=$AIUI_APP_API_ROOT
ARG AIUI_APP_IMAGE_REPO
ENV AIUI_APP_IMAGE_REPO=$AIUI_APP_IMAGE_REPO
ARG AIUI_APP_GIT_SHA
ENV AIUI_APP_GIT_SHA=$AIUI_APP_GIT_SHA
ARG AIUI_APP_VERSION
ENV AIUI_APP_VERSION=$AIUI_APP_VERSION

COPY --chown=1001:0 / $HOME/repo

WORKDIR $HOME/repo
RUN npm install --global yarn && \
    yarn install &&  \
    yarn run build:apps/assisted-ui &&  \
    cp -r apps/assisted-ui/{build,deploy} $HOME

FROM registry.access.redhat.com/ubi8/nginx-120 as app

ARG AIUI_APP_CLUSTER_PERMISSIONS
ENV AIUI_APP_CLUSTER_PERMISSIONS=$AIUI_APP_CLUSTER_PERMISSIONS
ARG AIUI_APP_API_ROOT
ENV AIUI_APP_API_ROOT=$AIUI_APP_API_ROOT
ARG AIUI_APP_IMAGE_REPO
ENV AIUI_APP_IMAGE_REPO=$AIUI_APP_IMAGE_REPO
ARG AIUI_APP_GIT_SHA
ENV AIUI_APP_GIT_SHA=$AIUI_APP_GIT_SHA
ARG AIUI_APP_VERSION
ENV AIUI_APP_VERSION=$AIUI_APP_VERSION

COPY --from=builder /opt/app-root/src/build/ "${NGINX_APP_ROOT}/src/"
COPY --from=builder /opt/app-root/src/deploy/ /deploy/

CMD [ "/deploy/start.sh" ]
